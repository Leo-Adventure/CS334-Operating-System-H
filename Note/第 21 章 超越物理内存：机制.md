## 第 21 章 超越物理内存：机制

问题描述：需要增加交换空间让操作系统为多个并发运行的进程都提供巨大地址空间的假象。多道程序和易用性都需要操作系统支持比物理内存更大的地址空间。

### 交换空间（Swap Space）

定义：在硬盘上的部分用于物理页移入和换出的空间

为了达到 操作系统能够以页大小为单元读取或者写入交换空间 的目的，OS 需要记住给定页的**硬盘地址**（disk address）

需要注意的是：交换空间并不是唯一的硬盘交换目的地

### 存在位

问题描述：在硬盘上有一定空间之后，我们需要在系统中增加一些更高级的机制来支持从硬盘交换页。

硬件（或者操作系统）判断是否页是否在内存中的方法就是通过 页表项（PTE）中存在位（present bit）来判断。如果存在位是 1，则代表存在物理内存中；如果是 0，则代表在硬盘上。

访问不在物理内存中的页，称为页错误（page fault）

发生页错误时，操作系统被唤起，处理页错误，执行 page-fault handler。

### 页错误（page fault）

对于 TLB 的管理，有两种方式：

- 硬件管理 TLB，有硬件在页表当中找到需要的转换映射
- 软件管理 TLB，由操作系统来执行查找过程

无论哪一种方式，页不存在的时候，都由**操作系统**来负责处理页错误（软件处理页错误）

页的磁盘位置信息存储在 PTE 用来存储 PFN 的位中

***

**以下是页错误处理的==流程==**

首先，操作系统必须为将要换入的页找到物理帧，如果没有，则需要等待交换算法的运行，此时，交换算法会通知后台分页线程按照需要释放页，线程释放一定数目的页帧，供这里使用。获得物理帧之后，处理程序发出 IO 请求从交换空间读取页。

然后，当硬盘 I/O 完成时，操作系统会更新页表，将此页标记为存在，并且更新页表项的 PFN 字段指向新获取页的内存位置，并且重试指令。

最后，注意下一次重新访问 TLB 还是未命中，再次访问重试之后，会将页表中的地址更新到 TLB 当中。最后的重试操作会在 TLB 找到转换映射，从已转换的内存物理区域地址，获取所需的数据以及指令。

***

因为 I/O 操作是昂贵的，所以在一个进程 页错误的时候会运行另一个进程。

### 交换发生时间

在实际当中，大多数操作系统会设置**高水位线**（High Watermark, HW）和**低水位线**（Low Watemark，LW）来帮助决定何时从内存中清除页。

当操作系统发现有少于 LW 个页可用时，后台负责释放内存的线程（有时称为 交换守护进程（swap daemon）或者页守护进程（page daemon））会开始运行，直到有 HW 个可用的物理页，然后它会进入休眠状态。

### 

