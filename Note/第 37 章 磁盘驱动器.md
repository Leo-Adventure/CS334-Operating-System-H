## 第 37 章 磁盘驱动器

在前一章介绍完 I/O 设备的一些概念以及操作系统如何进行交互之后，这里我们将详细介绍一种称为**磁盘驱动器（hard disk drive）**的设备。

磁盘驱动器一直是计算机系统中持久数据存储的主要形式

### 接口

驱动器由大量**扇区（512 字节块）**组成，因此可以将磁盘视作一组扇区。

更新磁盘的时候，需要保证单个512 字节的写入是原子的。

### 基本几何形状

磁盘可能有一个或多个**盘片（platter）**，每个盘片有两面，通过引入磁性变化来**永久**存储数据。盘片通常由一些硬质材料制成，并且涂上薄薄的磁性层，使得其在驱动器断电的情况下，也能持久存储数据位。

所有盘片围绕主轴（spindle）转动，旋转速率通常以**每分钟转数（Rotations Per Minute, RPM）**来衡量。

数据在扇区的同心圆的每个表面上被编码，这样的同心圆被称为一个**磁道（track）**

磁盘的读写过程由磁头（disk head）完成。

### 简单的磁盘驱动器

**单磁道延迟——旋转延迟（rotational delay）**：在磁盘需要读写某一个块内容的时候，磁盘需要等待期望的扇区旋转到磁头下。

**多磁道——寻道时间(seek time)**：为了服务读取扇区的请求，驱动器必须首先将磁盘臂移动到正确的磁道；在寻道完成之后，还需要有停放时间（settling time），等待转动延迟之后，最后才是传输（transfer）

为了确保即使在跨越磁道边界的时候，顺序读取也可以方便地服务，许多驱动器采用某种形式的**磁道偏斜（track skew）**，即位于相邻磁道的相邻扇区之间会彼此错开几个位置。

任何现代磁盘驱动器都有一个重要组成部分——缓存（cache）或者称为磁道缓冲区（track buffer），保存从磁盘读取或写入磁盘的数据。

在写入的时候，驱动器有两种选择：

- **后写（write back）**，在数据放入内存之后，报告写入完成
- **直写（write through）**，数据写入磁盘之后，报告写入完成

### I/O 时间

对于 I/O 所需的时间：
$$
T_{I/O} = T_{寻道} + T_{旋转} + T_{传输}
$$
对于I/O 的速率：
$$
R_{I/O} = \frac{传输大小}{T_{I/O}}
$$

### 磁盘调度

与任务调度不同，磁盘调度不知道每个任务的长度

#### SSTF：最短寻道时间优先

Shortest-Seek-Time-First

SSTF 按照磁道对 I/O 请求排序，选择在最近磁道的请求先完成

会导致两个问题：

1. 主机操作系统并不能利用驱动器的几何结构，而是只会看到一系列的块。这个问题可以通过 **最近块优先（Nearest-Block-First，NBF）**的方式解决。
2. 饥饿（starvation），使得所在位置外圈的磁道会饥饿

#### 电梯（SCAN 或 C-SCAN）

简单地以跨越磁道的顺序来服务磁盘请求。

C-SCAN 是从外圈扫到内圈，然后从内圈扫到外圈，如此下去

***

问题描述：这样就忽略了旋转的问题，需要同时考虑旋转以及寻道，来实现更接近 SJF 的算法

***

#### 最短定位时间优先(Shortest Positioning Time First, SPTF)

当寻道时间比旋转时间要长，那么使用 SSTF 可以很好地解决问题

但是在实际的现代磁盘驱动器当中，查找时间和旋转时间大致相当，所以需要使用 SPTF 算法

由于操作系统并不知道磁道边界以及磁头当前所在的位置，所以通常交给磁盘驱动器内部执行调度算法。

驱动器将会利用当前的磁头位置以及详细的磁道布局来以最佳可能 SPTF 顺序服务于这些请求。

#### 其他调度问题

磁盘驱动器还进行 I/O 合并，合并相邻的请求。这样可以减少发送到磁盘的请求数量，降低开销

